// application-configuration.js

"use strict";
define(["angularAMD",
        "angular-route",
        "ui-bootstrap",
        "angular-sanitize",
        "blockUI",
        "ui-router",
        "ui-grid",
        "jquery",
        "bootstrap",
        "jquery-ui-bootstrap"
    ],
    function (angularAMD) {
        console.log("##########  requirejs define begin  ################" + angularAMD);

        var app = angular.module("mainModule",
            ["ngRoute", "blockUI", "ngSanitize", "ui.bootstrap"]);

        app.config(function (blockUIConfig) {

            // Change the default overlay message
            blockUIConfig.message = 'Please stop clicking!';
            // Change the default delay to 100ms before the blocking is visible
            //blockUIConfig.delay = 10000000;
            //blockUIConfig.autoBlock = false;
        });

        app.config(["$routeProvider", function ($routeProvider) {

            $routeProvider
                .when("/", angularAMD.route({
                    log: console.log("##########  /  ################"),
                    //resolve: {
                    //    load: ["$q", "$rootScope", "$location","blockUI","$timeout",
                    //        function ($q, $rootScope, $location,blockUI,$timeout) {
                    //            blockUI.start("JUMP!!!....");
                    //            // blockUI.blockUIConfig.message=""
                    //            console.log("##########  /CCC  ################" + $q);
                    //            var deferred = $q.defer();
                    //            require(["views/tdframework/controller/mainPage0Controller"], function () {
                    //                $rootScope.$apply(function () {
                    //                    deferred.resolve();
                    //                });
                    //            });
                    //            $timeout(function() {
                    //                blockUI.stop();
                    //            }, 1000);
                    //            return deferred.promise;
                    //        }]
                    //},
                    templateUrl: function (rp) {
                        return "aaa.html";
                    }
                }))
                .when("/ccc/:name", angularAMD.route({
                //controllerUrl: "Views/Main/defaultController"
                resolve: {
                    load: ["$q", "$rootScope", "$location","blockUI","$timeout",
                        function ($q, $rootScope, $location,blockUI,$timeout) {
                            blockUI.start("JUMP!!!....");
                           // blockUI.blockUIConfig.message=""
                            console.log("##########  /CCC  ################" + $q);
                            var deferred = $q.defer();
                            require(["views/tdframework/controller/mainPage1Controller"], function () {
                                $rootScope.$apply(function () {
                                    deferred.resolve();
                                });
                            });
                            $timeout(function() {
                                blockUI.stop();
                            }, 1000);
                            return deferred.promise;
                        }]
                },
                    templateUrl: function (rp) {
                        return "ccc.html";
                    }
            }))
                .when("/:section/:tree", angularAMD.route({

                    templateUrl: function (rp) {
                        return "views/" + rp.section + "/" + rp.tree + ".html";
                    },

                    resolve: {
                        load: ["$q", "$rootScope", "$location",
                            function ($q, $rootScope, $location) {

                                var path = $location.path();
                                var parsePath = path.split("/");
                                var parentPath = parsePath[1];
                                var controllerName = parsePath[2];
                                var loadController = "views/" + parentPath + "/" +
                                    controllerName + "Controller";

                                console.log("############## when(/:section/:tree) loadController :" + loadController);
                                var deferred = $q.defer();
                                require([loadController], function () {
                                    $rootScope.$apply(function () {
                                        deferred.resolve();
                                    });
                                });
                                return deferred.promise;
                            }]
                    }
                }))
                .when("/:section/:tree/:id", angularAMD.route({

                    templateUrl: function (rp) {
                        return "views/" + rp.section + "/" + rp.tree + ".html";
                    },

                    resolve: {
                        load: ["$q", "$rootScope", "$location",
                            function ($q, $rootScope, $location) {
                                var path = $location.path();
                                var parsePath = path.split("/");
                                var parentPath = parsePath[1];
                                var controllerName = parsePath[2];
                                var loadController = "Views/" + parentPath + "/" +
                                        controllerName + "Controller";

                                var deferred = $q.defer();
                                require([loadController], function () {
                                    $rootScope.$apply(function () {
                                        deferred.resolve();
                                    });
                                });
                                return deferred.promise;
                            }]
                    }
                }))
                .otherwise(
                //{
                //log:console.log("##########  otherwise  ################"),
                //redirectTo: "bbb.html"
                //}
                angularAMD.route({
                        log: console.log("##########  otherwise  ################"),
                        templateUrl: function (rp) {
                            return "bbb.html";
                        }
                        //controllerUrl: "Views/Main/defaultController"

                    }
                ))
        }]);
        app.run(['$rootScope', '$location', function($rootScope, $location) {
            $rootScope.$on('$routeChangeSuccess', function(evt, next, previous) {
                console.log("########## $routeChangeSuccess next :" + next);
                console.log("########## $routeChangeSuccess previous :" + previous);
            });
        }]);
        // Bootstrap Angular when DOM is ready
        angularAMD.bootstrap(app);
        console.log("##########  angularAMD.bootstrap(app)  ################");
        app.controller("mainC",function($scope) {
            $scope.text0 = "asdfasdfsadfadsf111111111111----------------------";
        });

        app.controller("tabsController",
            function($scope, $compile) {



            $scope.createTab = function(id, label, pageUrl) {
                //alert(contextPath);
                var tabTemplate = "<li id='@{tabliid}'><a href='@{href}'>@{label} </a><span class='ui-icon ui-icon-close' style='float:right;cursor:pointer;'>Remove Tab</span></li>";

                var tabs = $('#tabsTitle').tabs();
                if (!document.getElementById("tabdiv_" + id)) {
                    var li = $( tabTemplate.replace( /@\{tabliid\}/g, "tabli_" + id ).replace( /@\{href\}/g, "#tabdiv_" + id ).replace( /@\{label\}/g, label ) );
                    tabs.find( ".ui-tabs-nav" ).append( li );
                    //var a = "<div id='tabdiv_" + id + "' style='height:100%;padding:0px;'>"
                    //    +"VVVVVVVV<ng-include src=\""+"'"+pageUrl+"'"+"\"></ng-include>VVVVVVVVVVVVV"
                    //    +"</div>";

                    //var newDirective = angular.element("<div ng-include=\""+"'"+pageUrl+"'"+"\"></div>");
                    //var newDirective = angular.element("<ng-view/>");
                    var newDirective = angular.element("<div ui-view='uiView"+id+"'></div>");
                    tabs.append( "<div id='tabdiv_" + id + "' style='height:100%;padding:0px;'>"
                        +"</div>" );
                    $("#tabdiv_" + id).append(newDirective);
                    $compile(newDirective)($scope);
                    //  console.log(newDirective);
                    tabs.tabs( "refresh" );
                    tabs.tabs('select' , "#tabdiv_"+id);
                } else {
                    tabs.tabs('select' , "#tabdiv_"+id);
                }
            }
            var tabs = $('#tabsTitle').tabs();

            //tabs.tabs('option', 'fx', { opacity: 'toggle' });
            $scope.createTab('welcome',"&#x6B22;&#x8FCE;", "ddd.html");


        });

        return app;
    });

