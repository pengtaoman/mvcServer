<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">

<!--
  - These entries must be added to your EXISTING applicationContext.xml. 
  - This applicationContext.xml cannot be used in its current form. It only
  - contains fragments of a real applicationContext.xml.
  -
  - $Id: applicationContext.xml,v 1.21 2005/09/08 00:43:09 lix Exp $
  -->

<beans>

    <bean id ="SecurityFactory" class="com.neusoft.unieap.service.security.SecurityFactory">
		<property name="authenticationManager"><ref bean="authenticationManager"/></property>  
		<property name="resourceAdapterFactory"><ref bean="resourceAdapterFactory"/></property>  	
		<property name="permissionManager"><ref bean="permissionManager"/></property>	
    </bean>
	<bean id="permissionManager" class="com.neusoft.tdframework.authorization.security.db.TDPermissionManager"/>

	<bean id="filterChainProxy" class="net.sf.acegisecurity.util.FilterChainProxy">
		<property name="filterInvocationDefinitionSource">
			<value>
		    CONVERT_URL_TO_LOWERCASE_BEFORE_COMPARISON
		    PATTERN_TYPE_APACHE_ANT
            /**=jcaptchaProcessingFilter,httpSessionContextIntegrationFilter,authenticationProcessingAjaxFilter,authenticationProcessingFilter,tdSimpleSecureFilter
         </value>
		</property>
	</bean>

	<bean id="tdSimpleSecureFilter" class="com.neusoft.tdframework.authorization.SecureFilterBean">
		<property name="loginFormUrl">
			<value>/login.do?method=begin</value>
		</property>
		<property name="simpleUrlPattern">
			<value>*.do;*.jsp;*.html;*.htm;*.xml</value>
		</property>
		<property name="filterChainProxy">
			<ref bean="filterChainProxy" />
		</property>
		<property name="authenticationManager">
			<ref bean="authenticationManager"/>
		</property>
		<!-- 
		<property name="reloginProcessing">
		    <ref bean="reloginProcessing"/>
		</property>
		 -->
	</bean>	
	
	<bean id ="jcaptchaProcessingFilter" class="com.neusoft.tdframework.authorization.JcaptchaProcessingFilter">
		<property name="jfilterProcessesUrl"><value>/j_unieap_security_check.do</value></property>  
		<property name="jdefaultTargetUrl"><value>/login.do?method=begin</value></property>  	
    </bean>


   <bean id="httpSessionContextIntegrationFilter" class="net.sf.acegisecurity.context.HttpSessionContextIntegrationFilter">
      <property name="context"><value>net.sf.acegisecurity.context.security.SecureContextImpl</value></property>
   </bean>

	<bean id="filterInvocationInterceptor" class="com.neusoft.unieap.service.security.intercept.filter.FilterSecurityInterceptor">
    	<property name="authenticationManager"><ref bean="authenticationManager"/></property>
    	<property name="accessDecisionManager"><ref bean="accessDecisionManager"/></property>
 		<property name="objectDefinitionSource">
			<value>
			    CONVERT_URL_TO_LOWERCASE_BEFORE_COMPARISON
			    PATTERN_TYPE_APACHE_ANT
			    /**/login*begin=UNIEAP_PASS
				/**/images/**=UNIEAP_PASS
				/**/error.*=UNIEAP_PASS
				/**/login*error=UNIEAP_PASS
				/toollistener**=UNIEAP_PASS 
			    /**=UNIEAP_MENU
			</value>
		</property>
	</bean>
	
	<bean id="accountPolicyFilter" class="com.neusoft.unieap.service.security.accountPolicy.AccountPolicyFilter">
	</bean>	

	<bean id="authenticationManager" class="net.sf.acegisecurity.providers.ProviderManager">
		<property name="providers">
		  <list>
		    <!--<ref bean="X509AuthenticationProvider"/>-->
		    <ref bean="daoAuthenticationProvider"/>
		    <!--<ref bean="jaasAuthenticationProvider"/>-->
		  </list>
		</property>
	</bean>	
	
	<!--bean for the DAO-->
	<bean id="daoAuthenticationProvider" class="net.sf.acegisecurity.providers.dao.DaoAuthenticationProvider">
     	<property name="authenticationDao"><ref bean="authenticationDao"/></property>
     	<property name="userCache"><ref local="userCache"/></property>
	</bean>
	<bean id="authenticationDao" class="com.neusoft.tdframework.authorization.UnieapOrgDaoImpl"/>
	
	<bean id="cacheManager" class="org.springframework.cache.ehcache.EhCacheManagerFactoryBean">
	    <property name="configLocation">
            <value>/WEB-INF/conf/unieap/security/ehcache-failsafe.xml</value>
        </property>
         <property name="shared">
            <value>true</value>
        </property>
    </bean>	
    
   <bean id="userCacheBackend" class="org.springframework.cache.ehcache.EhCacheFactoryBean">
      <property name="cacheManager">
         <ref local="cacheManager"/>
      </property>
      <property name="cacheName">
         <value>userCache</value>
      </property>
   </bean>
   <bean id="userCache" class="net.sf.acegisecurity.providers.dao.cache.EhCacheBasedUserCache">
      <property name="cache"><ref local="userCacheBackend"/></property>
   </bean> 

    <!--  Ȩ���ж����� -->
	<bean id="unieapVoter" class="com.neusoft.unieap.service.security.vote.UnieapVoter"/>
	<!--<bean id="unieapVoter" class="com.neusoft.unieap.example.security.vote.UnieapMenuVoter"/>-->

	<bean id="accessDecisionManager" class="net.sf.acegisecurity.vote.AffirmativeBased">
   		<property name="allowIfAllAbstainDecisions"><value>false</value></property>
		<property name="decisionVoters">
		  <list>
		    <ref bean="unieapVoter"/>
		  </list>
		</property>
	</bean>
	
	<bean id="securityEnforcementFilter" class="com.neusoft.unieap.service.security.ui.webapp.UniEAPSecurityEnforcementFilter">
		<property name="filterSecurityInterceptor"><ref bean="filterInvocationInterceptor"/></property>
		<property name="authenticationEntryPoint"><ref bean="authenticationProcessingFilterEntryPoint"/></property>
	</bean>
	    
	<bean id="authenticationProcessingFilter" class="com.neusoft.tdframework.authorization.TDAuthenticationProcessingFilter">
	<!--<bean id="authenticationProcessingFilter" class="net.sf.acegisecurity.ui.webapp.AuthenticationProcessingFilter">-->
		<property name="authenticationManager"><ref bean="authenticationManager"/></property>
		<property name="authenticationFailureUrl"><value>/login.do?method=error</value></property>
		<property name="defaultTargetUrl"><value>/login.do?method=login</value></property>
		<property name="alwaysUseDefaultTargetUrl"><value>false</value></property>
		<property name="filterProcessesUrl"><value>/j_unieap_security_check.do</value></property>
	</bean>
	<bean id="authenticationProcessingFilterEntryPoint" class="net.sf.acegisecurity.ui.webapp.AuthenticationProcessingFilterEntryPoint">
		<property name="loginFormUrl"><value>/login.do?method=begin</value></property>
		<property name="forceHttps"><value>false</value></property>
	</bean>
	
 	<bean id="resourceAdapterFactory" class="com.neusoft.unieap.service.security.resource.ResourceAdapterFactory">
		<property name="resourceAdapterMap">
		 <map>
                <entry key="menu">
                    <bean class="com.neusoft.unieap.service.security.resource.adapters.menu.MenuResourceAdapter"/>
                </entry>
                 <entry key="data">
                    <bean class="com.neusoft.unieap.service.security.resource.adapters.data.DataResourceAdapter"/>
                </entry>
                <entry key="filter">
                    <bean class="com.neusoft.unieap.service.security.resource.adapters.filter.FilterResourceAdapter"/>
                </entry>
                <entry key="page">
                    <bean class="com.neusoft.unieap.service.security.resource.adapters.page.PageResourceAdapter"/>
                </entry>                
           </map>     
		</property>
	</bean>   
	
    <bean id="authenticationProcessingAjaxFilter" class="com.neusoft.unieap.service.security.ui.webapp.AuthenticationProcessingFilter">
	<!--<bean id="authenticationProcessingFilter" class="net.sf.acegisecurity.ui.webapp.AuthenticationProcessingFilter">-->
		<property name="authenticationManager"><ref bean="authenticationManager"/></property>
		<property name="authenticationFailureUrl"><value>/relogin.do?method=error</value></property>
		<property name="defaultTargetUrl"><value>/relogin.do?method=relogin</value></property>
		<property name="alwaysUseDefaultTargetUrl"><value>true</value></property>
		<property name="filterProcessesUrl"><value>/j_unieap_security_ajaxcheck.do</value></property>
	</bean>
	
	<bean id="reloginProcessing" class="com.neusoft.unieap.service.security.ui.webapp.ReloginProcessing">
		<property name="processesUrl">
			<list>
				<value>/login.do</value>
				<value>/index.jsp</value>
				<value>/unieap/pages/index.jsp</value>
				<value>/enterapp.do</value>
			</list>
		</property>
		<property name="targetUrl"><value>/unieap/pages/error.jsp</value></property>		
	</bean>
	
</beans>
